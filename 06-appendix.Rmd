# (APPENDIX) Appendix {-}

# Glossary of important `R` commands

The following table contains important `R` commands for its **basic usage**.

|             Description         |        `R`       |              Example                |
|---------------------------------|------------------|-------------------------------------|
| **Assign values to a variable** | `<-` | `x <- 1` |
| **Compute several expressions at once** | `;` | `x <- 1; 2 + 2; 3 * 8` |
| **Create vectors by concatenating numbers** | `c` | `c(1, 2, -1)` |
| **Create sequential integer vectors** | `:` | `1:10` |
| **Create a matrix by columns** | `cbind` | `cbind(1:3, c(0, 2, 0))` |
| **Create a matrix by rows** | `rbind` | `rbind(1:3, c(0, 2, 0))` |
| **Create a data frame** | `data.frame` | `data.frame(name1 = c(-1, 3), name2 = c(0.4, 1))` |
| **Create a list** | `list` | `list(obj1 = c(-1, 3), obj2 = -1:5, obj3 = rbind(1:2, 3:2))` |
| **Access elements of a...** |  | |
| ... vector | `[]`| `c(0.5, 2)[1], c(0.5, 2)[-1]; c(0.5, 2)[2:1]`|
| ... matrix | `[, ]`| `cbind(1:2, 3:4)[1, 2]; cbind(1:2, 3:4)[1, ]` |
| ... data frame | `[, ]` and `$`| `data.frame(name1 = c(-1, 3), name2 = c(0.4, 1))$name1; data.frame(name1 = c(-1, 3), name2 = c(0.4, 1))[2, 1]` |
| ... list | `$`| `list(x = 2, y = 7:0)$y` |
| **Summarize any object** | `summary` | `summary(1:10)` |


The useful commands for performing **simple and multiple linear regression** are given in the next table. We assume that:

- `dataset` is an imported dataset such that
    - `resp` is the response variable
    - `pred1` is first predictor
    - `pred2` is second predictor
    - ...
    - `predk` is the last predictor
- `model` is the result of applying `lm`
- `newPreds` is a `data.frame` with variables named as the predictors
- `num` is `1`, `2` or `3`

|               Description          |              `R`             |
|------------------------------------|------------------------------|
| **Fit a simple linear model ** | `lm(response ~ pred1, data = dataset)` |
| **Fit a multiple linear model... ** | |
| ... on two predictors | `lm(response ~ pred1 + pred2, data = dataset)` |
| ... on all predictors | `lm(response ~ ., data = dataset)` |
| ... on all predictors except `pred1` | `lm(response ~ . - pred1, data = dataset)` |
|  **Summarize linear model**: coefficient estimates, standard errors, $t$-values, $p$-values for $H_0:\beta_j=0$, $\hat\sigma$ (Residual standard error), degrees of freedom, $R^2$, Adjusted $R^2$, $F$-test, $p$-value for $H_0:\beta_1=\ldots=\beta_k=0$ | `summary(model)` |
| **ANOVA decomposition** | `anova(model)` |
| **CIs coefficients** | `confint(model, level = level)` |
| **Prediction** | `predict(model, newdata = new)` |
| **CIs predicted mean** | `predict(model, newdata = new, interval = "confidence", level = level)` |
| **CIs predicted response** | `predict(model, newdata = new, interval = "prediction", level = level)` |
| **Variable selection** | `stepwise(model)` |
| **Compare model coefficients** | `compareCoefs(model1, model2)` |
| **Diagnostic plots** | `plot(model, num)` |

# Group project

#### Groups {-}

You will team up in groups of 3 to 5 members. It is up to you to form the groups based on your grade expectations, affinity, complementary skills, etc. You must communicate the group compositions **no later than November the 30th** by a (single) email to <edgarcia@est-econ.uc3m.es> detailing the members of the group and, if you have it, a preliminary description about the topic of the project (~ 3 lines).

#### Aim of the project {-}

You will analyse a real dataset of your choice using the statistical methodology that we have seen in the lessons and labs. The purpose is to demonstrate that you know how to apply and interpret some of the studied statistical techniques (such as simple/multiple linear regression, logistic regression, or any other methods covered in the course) in a real-case scenario that is appealing for you.

#### Structure of the report {-}

Use the following *mandatory* structure when writing your report:

0. **Abstract**. Provide a concise summary of the project. It must not exceed 250 words.
1. **Introduction**. State what is the problem to be studied. Provide some context, the question(s) that you want to address, a motivation of its importance, references, etc. Remember how we introduced the case studies covered in the course as a template (but you will need to elaborate more).
2. **Statistical analysis**. Make use of some of the aforementioned statistical techniques, the ones that are more convenient to your particular case study. You can choose between covering several at a more superficial level, or one or two in more depth. Justify their adequacy and obtain analyses, explaining how you did it, in the form of plots and summaries. Provide a critical discussion about the outputs and give insights about them.
3. **Conclusions**. Summary of what was addressed in the project and of the most important conclusions. Takeaway messages. The conclusions are not required to be spectacular, but *fair and honest* in terms of what you discovered.
4. **References**. Refer to the sources of information that you have employed (for the data, for information on the data, for the statistical analyses, etc).

*Mandatory* format guidelines:

- Structure: title, authors, abstract, first section, second section and so on. Like [this](http://cje.oxfordjournals.org/content/38/2/257.full.pdf+html). Do not use a cover.
- Font size: 12 points.
- Spacing: single space, single column.
- Length limit: less than 5000 words **and** 15 pages. You are **not** required to make use of all the space.

#### Grading {-}

All students in a group will be graded evenly. Take this into account when forming the group. The grading is on a scale of 0-10 (plus 2 bonus points) and will be performed according to the following breakdown:

- **Originality** of the problem studied and data acquisition process (up to 2 points).
- **Statistical analyses presented** and their depth (up to 3 points). At least two different techniques should be employed (simple and multiple linear regression count as different, but the use of other techniques as well is mostly encouraged). Graded depending on their adequacy to the problem studied and the evidence you demonstrate about your knowledge of them.
- Accuracy of the **interpretation** of the analyses (up to 2 points). Graded depending on the detail and rigor of the insights you elaborate from the statistical analyses.
- **Reproducibility** of the study (1.5 point). Awarded if the code for reproducing the study, as well as the data, is provided in a ready-to-use way (e.g. the outputs from `R Commander`'s report mode along with the data).
- **Presentation** of the report (1.5 point). This involves the correct usage of English, the readability, the conciseness and the overall presentation quality.
- **Excellence** (2 bonus points). Awarded for creativity of the analysis,  use of advanced statistical tools, use of points briefly covered in lessons/labs, advanced insights into the methods, completeness of the report, use of advanced presentation tools, etc. Only awarded if the sum of regular points is above 7.5.

The ratio "quality project"/"group size" might be taken into account in extreme cases (e.g. poor report written by 5 people, extremely good report written by 3 people).

#### Academic fraud {-}

Evidences of academic fraud will have serious consequences, such as a zero grade for the whole group and the reporting of the fraud detection to the pertinent academic authorities. Academic fraud includes (but is not limited to) plagiarism, use of sources without proper credit, project outsourcing and the use of external tutoring not mentioned explicitly.

#### Tips {-}

- Think about a topic that could be reused for other subjects, or take inspiration from previous projects you did. In that way, this project could serve as the *quantification* of another subject's project. If you do this, **add an explicit mention** in the report.
- Data sources. Here are some useful data sources:
	* A [list of all the datasets included in `R`](http://vincentarelbundock.github.io/Rdatasets/datasets.html). See [Section 2.9.1](https://bookdown.org/egarpor/SSS2-UC3M/exercises-and-case-studies.html) of lab notes for how to load them.
	* [Some datasets employed in the course](https://bookdown.org/egarpor/SSS2-UC3M/datasets-for-the-course.html).
	* [The World Bank](http://data.worldbank.org) contains a huge collection of economic and sociological variables for countries and regions, for long periods of time.
	* [SIPRI](https://www.sipri.org/) contains several databases about international transfers of arms.
	* The [Global Health Observatory](http://www.who.int/gho/database/en/) is the World Health Organization's main health statistics repository.
	* Sport statistics (teams, players) are a great source if you like sports. Sport webpages usually have a section on statistics.
- Inspiration for the project's topic.
	* The case studies covered (and left as exercises) in the lab notes might serve as a good starting point for defining a project.
	* [The Economist](http://www.economist.com/) usually has some good and up-to-date political/economical analyses that could serve as motivation.
	* Try to quantify the impact in society of certain laws (traffic, education, gender violence, etc).
	* Is there a continuous variable that you would like to predict from others? (linear regression)
	* Is there a binary variable that you would like to predict from others? (logistic regression)
	* Would you like to assess which combination of variables explain most of the variability of your data, so you can visualize it in 2D or 3D? (principal component analysis)
	* Would you like aggregate individuals according to several characteristics in order to classify them? (clustering)
- Use `R Commander`'s report mode (Appendix \@ref(reporting-with-r-and-r-commander)) to simplify the generation of graphs and summaries directly from the statistical analysis. Use that code to make the analysis reproducible.
- Make use of office hours before it is too late.
- Pro-tip: if you come to my office with a printed draft of the project, I can provide you some quick feedback on what could be improved.

#### Deadline {-}

Send the reports before December the 23rd at 23:59 through Aula Global. **Not by email**. Reports received after the deadline will not be evaluated.

# Reporting with `R` and `R Commander`

A nice feature of `R Commander` is that integrates seamless with `R Markdown`, which is able to create `.html`, `.pdf` and `.docx` reports directly from the outputs of `R`. Depending on the kind of report that we want, we will need the following auxiliary software^[Alternatively, the `'Tools' -> 'Install auxiliary software [if not already installed]'` will redirect you to the download links for the auxiliary software.]:

- `.html`. No extra software is required.
- `.docx` and `.rtf`. You must install `Pandoc`, a document converter software. Download it [here](http://pandoc.org/installing.html).
- `.pdf` (only recommended for experts). An installation of LaTeX, additionally to `Pandoc`, is needed. Download LaTeX [here](https://www.latex-project.org/get/).

The workflow is simple. Once you have done some statistical analysis, either by using `R Commander`'s menus or `R` code directly, you will end up with an `R` script, on the `'R Script'` tab, that contains all the commands you have run so far. Switch then to the `'R Markdown'` tab and you will see the commands you have entered in a different layout, which essentially encapsulates the code into chunks delimited by `` ```{r}`` and `` ``` ``. This will generate a report once you click in the `'Generate report'` button.

Let's illustrate this process through an example. Suppose we were analyzing the `Boston` dataset, as we did in Section \@ref(boston). *Ideally*^[This is, assuming we have performed the right steps in the analysis without making any mistake.] our final script would be something like this:
```{r, echo=FALSE,message=FALSE,warning=FALSE}
library(RcmdrMisc)
```
```{r, eval = FALSE}
# A simple and non-exhaustive analysis for the price of the houses in the Boston
# dataset. The purpose is to quantify, by means of a multiple linear model,
# the effect of 14 variables in the price of a house in the suburbs of Boston.

# Import data
library(MASS)
data(Boston)

# Make a multiple linear regression od medv in the rest of variables
mod <- lm(medv ~ ., data = Boston)
summary(mod)

# Check the linearty assumption
plot(mod, 1) # Clear non-linearity

# Let's consider the transformations given in Harrison and Rubinfeld (1978)
modTransf <- lm(I(log(medv * 1000)) ~ I(rm^2) + age + log(dis) +
                  log(rad) + tax + ptratio + I(black / 1000) +
                  I(log(lstat / 100)) + crim + zn + indus + chas +
                  I((10 * nox)^2), data = Boston)
summary(modTransf)

# The non-linearity is more subtle now
plot(modTransf, 1)

# Look for the best model in terms of the BIC
modTransfBIC <- stepwise(modTransf)
summary(modTransfBIC)

# Let's explore the most significant variables, to see if the model can be
# reduced drastically in complexity
mod3D <- lm(I(log(medv * 1000)) ~ I(log(lstat / 100)) + crim, data = Boston)
summary(mod3D)

# With only 2 variables, we explain the 72% of variability.
# Compared with the 80% with 10 variables, it is an important improvement
# in terms of simplicity.

# Let's add these variables to the dataset, so we can call scatterplotMatrix
# and scatter3d through R Commander's menu
Boston$logMedv <- log(Boston$medv * 1000)
Boston$logLstat <- log(Boston$lstat / 100)

# Visualize the pair-by-pair relations of the response and two predictors
scatterplotMatrix(~ crim + logLstat + logMedv, reg.line = lm, smooth = FALSE,
                  spread = FALSE, span = 0.5, ellipse = FALSE,
                  levels = c(.5, .9), id.n = 0, diagonal = 'histogram',
                  data = Boston)

# Visualize the full relation between the response and the two predictors
scatter3d(logMedv ~ crim + logLstat, data = Boston, fit = "linear",
          residuals = TRUE, bg = "white", axis.scales = TRUE, grid = TRUE,
          ellipsoid = FALSE)
```
This contains all the major points in the analysis, that now can be expanded and detailed. You can download the script [here](https://raw.githubusercontent.com/egarpor/SSS2-UC3M/master/reporting/report-script.R), open it through `'File' -> 'Open script file...'` and run it by yourself in `R Commander`. If you so, and then switch to the `R Markdown` tab, you will see this:
    
    ---
    title: "Replace with Main Title"
    author: "Your Name"
    date: "AUTOMATIC"
    ---
    
    `r ''````{r echo=FALSE, message=FALSE}
    # include this code chunk as-is to set options
    knitr::opts_chunk$set(comment=NA, prompt=TRUE)
    library(Rcmdr)
    library(car)
    library(RcmdrMisc)
    ```
    
    `r ''````{r echo=FALSE}
    # include this code chunk as-is to enable 3D graphs
    library(rgl)
    knitr::knit_hooks$set(webgl = hook_webgl)
    ```
    
    `r ''````{r}
    # A simple and non-exhaustive analysis for the price of the houses in the Boston
    ```
    
    `r ''````{r}
    # dataset. The purpose is to quantify, by means of a multiple linear model,
    ```
    
    `r ''````{r}
    # the effect of 14 variables in the price of a house in the suburbs of Boston.
    ```
    
    `r ''````{r}
    # Import data
    ```
    
    `r ''````{r}
    library(MASS)
    ```
    
    `r ''````{r}
    data(Boston)
    ```
    
    `r ''````{r}
    # Make a multiple linear regression od medv in the rest of variables
    ```
    
    `r ''````{r}
    mod <- lm(medv ~ ., data = Boston)
    ```
    
    `r ''````{r}
    summary(mod)
    ```
    
    [More outputs - omitted]
    ```

The complete, lengthy, file can be downloaded [here](https://raw.githubusercontent.com/egarpor/SSS2-UC3M/master/reporting/crude-report.Rmd). This is an `R Markdown` file, which has extension `.Rmd`. As you can see, by default, `R Commander` will generate a *code chunk* like

    `r ''````{r}
    code line
    ```
    
for each `code line` you run in `R Commander`. You probably will want to modify this *crude* report manually by merging chunks of code, removing comments or adding more information in between chunks of code. To do so, go to `'Edit' -> 'Edit Markdown document'`. Here you can also remove unnecessary chunks of code resulting from any mistake or irrelevant analyses.

The following file ([download](https://raw.githubusercontent.com/egarpor/SSS2-UC3M/master/reporting/report.Rmd)) could be a final report. Pay attention to the numerous changes with respect to the previous one:

    ---
    title: "What makes a house valuable?"
    subtitle: "A reproducible analysis in the Boston suburbs"
    author: "Outstanding student 1, Awesome student 2 and Great student 3"
    date: "31/11/16"
    ---
    
    `r ''````{r echo=FALSE, message=FALSE, warning=FALSE}
    # include this code chunk as-is to set options
    knitr::opts_chunk$set(comment=NA, prompt=TRUE)
    library(Rcmdr)
    library(car)
    library(RcmdrMisc)
    ```
    
    `r ''````{r echo=FALSE, message=FALSE, warning=FALSE}
    # include this code chunk as-is to enable 3D graphs
    library(rgl)
    knitr::knit_hooks$set(webgl = hook_webgl)
    ```
    
    This short report shows a simple and non-exhaustive analysis for the price of
    the houses in the `Boston` dataset. The purpose is to quantify, by means of a
    multiple linear model, the effect of 14 variables in the price of a house in
    the suburbs of Boston.
    
    We start by importing the data into `R` and considering a multiple linear
    regression of `medv` (median house value) in the rest of variables:
    `r ''````{r}
    # Import data
    library(MASS)
    data(Boston)
    ```
    
    `r ''````{r}
    mod <- lm(medv ~ ., data = Boston)
    summary(mod)
    ```
    The variables `indus` and `age` are non-significant in this model. Also,
    although the adjusted R-squared is high, there seems to be a clear
    non-linearity:
    `r ''````{r}
    plot(mod, 1)
    ```
    
    In order to bypass the non-linearity, we are going to consider the
    non-linear transformations given in Harrison and Rubinfeld (1978)
    for both the response and the predictors:
    `r ''````{r}
    modTransf <- lm(I(log(medv * 1000)) ~ I(rm^2) + age + log(dis) +
                    log(rad) + tax + ptratio + I(black / 1000) +
                    I(log(lstat / 100)) + crim + zn + indus + chas +
                    I((10*nox)^2), data = Boston)
    summary(modTransf)
    ```
    The adjusted R-squared is now higher and, what is more important, the
    non-linearity now is more subtle (it is still not linear but closer
    than before):
    `r ''````{r}
    plot(modTransf, 1)
    ```
    
    However, `modTransf` has more non-significant variables. Let\'s see if
    we can improve over the previous model by removing some of the
    non-significant variables? To see this, we look for the best model in
    terms of the Bayesian Information Criterion (BIC) by `stepwise`:
    `r ''````{r}
    modTransfBIC <- stepwise(modTransf, trace = 0)
    summary(modTransfBIC)
    ```
    The resulting model has a slightly higher adjusted R-squared than `modTransf`
    with all the variables significant.
    
    We explore the most significant variables to see if the model can be reduced
    drastically in complexity.
    `r ''````{r}
    mod3D <- lm(I(log(medv * 1000)) ~ I(log(lstat / 100)) + crim, data = Boston)
    summary(mod3D)
    ```
    
    It turns out that **with only 2 variables, we explain the 72% of variability**.
    Compared with the 80% with 10 variables, it is an important improvement
    in terms of simplicity: the logarithm of `lstat` (percent of lower status of
    the population) and `crim` (crime rate) alone explain the 72% of the
    variability in the house prices.
    
    We add these variables to the dataset, so we can call `scatterplotMatrix` and
    `scatter3d` through `R Commander`,
    `r ''````{r}
    Boston$logMedv <- log(Boston$medv * 1000)
    Boston$logLstat <- log(Boston$lstat / 100)
    ```
    and conclude with the visualization of:
    
    1. the pair-by-pair relations of the response and the two predictors;
    2. the full relation between the response and the two predictors.
    `r ''````{r}
    # 1
    scatterplotMatrix(~ crim + logLstat + logMedv, reg.line = lm, smooth = FALSE,
                      spread = FALSE, span = 0.5, ellipse = FALSE,
                      levels = c(.5, .9), id.n = 0, diagonal = 'histogram',
                      data = Boston)
    ```
    `r ''````{r webgl=TRUE}
    # 2
    scatter3d(logMedv ~ crim + logLstat, data = Boston, fit = "linear",
              residuals = TRUE, bg = "white", axis.scales = TRUE, grid = TRUE,
              ellipsoid = FALSE)
    ```

When we click on `'Generate report'` for the above `R Markdown` file, we should get the following output files:

- `.html`: [visualize](http://htmlpreview.github.io/?https://raw.githubusercontent.com/egarpor/SSS2-UC3M/master/reporting/report.html) and [download](https://raw.githubusercontent.com/egarpor/SSS2-UC3M/master/reporting/report.html). Once it is produced, this file is difficult to modify, but very easy to distribute (anyone with a browser can see it).
- `.docx`: [visualize and download](https://raw.githubusercontent.com/egarpor/SSS2-UC3M/master/reporting/report.docx). Easy to modify in a document processor like Microsoft Office. Easy to distribute.
- `.rtf`: [download](https://raw.githubusercontent.com/egarpor/SSS2-UC3M/master/reporting/report.rtf). Easy to modify in a document processor, not very elegant.
- `.pdf`: [visualize and download](https://raw.githubusercontent.com/egarpor/SSS2-UC3M/master/reporting/report.pdf). Elegant and easy to distribute, but hard to modify once it is produced.

```{block, type = 'rmdtip'}
For advanced users, there is a lot of information on mastering `R Markdown` [here](http://rmarkdown.rstudio.com/lesson-1.html) by using `RStudio`, a more advanced framework than `R Commander`.
```
